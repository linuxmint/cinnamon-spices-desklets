const Desklet = imports.ui.desklet;
const St = imports.gi.St;
const GLib = imports.gi.GLib;
const Util = imports.misc.util;
const Mainloop = imports.mainloop;
const Lang = imports.lang;
const Gio = imports.gi.Gio;
const ByteArray = imports.byteArray;
const Gettext = imports.gettext;

const UUID = "lenovo-vantage@thewraith420";

// l10n/translation support
Gettext.bindtextdomain(UUID, GLib.get_home_dir() + "/.local/share/locale");

function _(str) {
    return Gettext.dgettext(UUID, str);
}

function MyDesklet(metadata, desklet_id) {
    this._init(metadata, desklet_id);
}

function main(metadata, desklet_id) {
    return new MyDesklet(metadata, desklet_id);
}

MyDesklet.prototype = {
    __proto__: Desklet.Desklet.prototype,

    _init: function(metadata, desklet_id) {
        Desklet.Desklet.prototype._init.call(this, metadata, desklet_id);

        try {
            this.setHeader(_("Lenovo Vantage"));
            
            this.mainLabel = new St.Label({ text: "Loading...", style_class: 'main-label' });
            this.setContent(this.mainLabel);
            
            this._update();

        } catch (e) {
            global.logError(e);
        }
    },
    
    _update: function() {
        // Paths to battery files
        const ENERGY_NOW_FILE = "/sys/class/power_supply/BAT1/energy_now";
        const ENERGY_FULL_FILE = "/sys/class/power_supply/BAT1/energy_full";
        const POWER_NOW_FILE = "/sys/class/power_supply/BAT1/power_now";
        const STATUS_FILE = "/sys/class/power_supply/BAT1/status";
        const CONSERVATION_FILE = "/sys/bus/platform/drivers/ideapad_acpi/VPC2004:00/conservation_mode";
        const RAPID_CHARGE_FILE = "/sys/bus/platform/drivers/legion/PNP0C09:00/rapidcharge";

        let displayText = "";
        let percentage = 0;
        let timeText = "";
        let conservationText = "";
        let rapidText = "";

        try {
            // Battery Percentage and Time
            let energyNow = parseInt(this._readFromFile(ENERGY_NOW_FILE));
            let energyFull = parseInt(this._readFromFile(ENERGY_FULL_FILE));
            let powerNow = parseInt(this._readFromFile(POWER_NOW_FILE));
            let status = this._readFromFile(STATUS_FILE).trim();

            if (energyFull > 0) {
                percentage = Math.round((energyNow / energyFull) * 100);
            }

            if (status === "Discharging" && powerNow > 0) {
                let timeHours = energyNow / powerNow;
                let hours = Math.floor(timeHours);
                let minutes = Math.round((timeHours - hours) * 60);
                timeText = `(${hours}h ${minutes}m left)`;
            } else {
                timeText = `(${status})`;
            }
            
            displayText += `${percentage}% ${timeText}\n`;

            // Conservation Mode
            let conservationMode = this._readFromFile(CONSERVATION_FILE).trim() === '1';
            conservationText = `Conservation: ${conservationMode ? 'ON' : 'OFF'}`;
            displayText += conservationText + "\n";

            // Rapid Charge
            let rapidChargeMode = this._readFromFile(RAPID_CHARGE_FILE).trim() === '1';
            rapidText = `Rapid Charge: ${rapidChargeMode ? 'ON' : 'OFF'}`;
            displayText += rapidText;

            this.mainLabel.set_text(displayText);

        } catch (e) {
            this.mainLabel.set_text("Error loading battery info.\n" + e.message);
        }
        
        // Schedule next update
        this.timeout = Mainloop.timeout_add_seconds(5, Lang.bind(this, this._update));
        return true;
    },

    _readFromFile: function(path) {
        let file = Gio.file_new_for_path(path);
        let [success, contents] = file.load_contents(null);
        if (success) {
            return ByteArray.toString(contents);
        } else {
            throw new Error("Could not read file: " + path);
        }
    },

    on_desklet_removed: function() {
        if (this.timeout) {
            Mainloop.source_remove(this.timeout);
        }
    }
};
